rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function getUserData(userId) {
        return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isAdmin() {
      // Check the user's custom claim or their role in the 'users' collection.
      return isAuth() && getUserData(request.auth.uid).role == 'admin';
    }
    
    function isFormateur() {
        return isAuth() && getUserData(request.auth.uid).role == 'formateur';
    }
    
     function isValidatedFormateur() {
        let userData = getUserData(request.auth.uid);
        return isAuth() && userData.role == 'formateur' && userData.validation_status == 'validated';
    }

    // --- Users Collection ---
    // Users can read their own profile. Admins can read any profile.
    // Users can create their own profile.
    // Users can update their own profile, but cannot change their role.
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && request.resource.data.role == resource.data.role;
      // Admins can update any field, including the role.
      allow update: if isAdmin();
    }
    
    // --- Enrollments Subcollection (User Progress) ---
    // A user can only manage their own enrollments/progress.
    match /users/{userId}/enrollments/{enrollmentId} {
        allow read, write: if isOwner(userId);
    }
    
    // --- Formations (Courses) Collection ---
    match /formations/{formationId} {
      // Anyone can read published courses.
      // Validated instructors and admins can read any course.
      allow read: if resource.data.published == true || isValidatedFormateur() || isAdmin();
      
      // Only validated instructors or admins can create courses.
      allow create: if isValidatedFormateur() || isAdmin();
      
      // Only the author instructor or an admin can update/delete.
      allow update, delete: if (isAuth() && resource.data.authorId == request.auth.uid) || isAdmin();
    }
    
    // --- Modules & Videos Subcollections ---
    match /formations/{formationId}/{subcollection}/{documentId} {
        // Anyone can read if the parent course is readable.
        allow read: if get(/databases/$(database)/documents/formations/$(formationId)).data.published == true || (isAuth() && get(/databases/$(database)/documents/formations/$(formationId)).data.authorId == request.auth.uid) || isAdmin();
        
        // Only the author of the course or an admin can write to subcollections.
        allow write: if (isAuth() && get(/databases/$(database)/documents/formations/$(formationId)).data.authorId == request.auth.uid) || isAdmin();
    }

    // --- Donations Collection ---
    match /donations/{donationId} {
      // A user can create their own donation document, but only with a pending status.
      allow create: if isAuth() && request.resource.data.donateurId == request.auth.uid && request.resource.data.statut == 'en_attente';
      // A user can read their own donations. Admins can read all.
      allow read: if (isAuth() && resource.data.donateurId == request.auth.uid) || isAdmin();
      // No one can update a donation from the client. This MUST be done by a trusted server (webhook).
      allow update, delete: if false;
    }
    
    // --- Aggregated Stats & Analytics (Server-only write) ---
    match /formateur_stats/{authorId} {
        // The instructor can read their own stats. Admins can read any.
        allow read: if isOwner(authorId) || isAdmin();
        // Writes are only allowed from the backend (Admin SDK).
        allow write: if false;
    }

    match /analytics/{courseId}/{subcollection}/{docId} {
        // Allow admins and the course author to read analytics data for dashboards.
        allow read: if (isAuth() && get(/databases/$(database)/documents/formations/$(courseId)).data.authorId == request.auth.uid) || isAdmin();
        // Writes are only allowed from the backend.
        allow write: if false;
    }

    // --- Instructor & Admin Collections ---
    match /instructor_requests/{requestId} {
        allow read: if isOwner(requestId) || isAdmin();
        allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
        allow update: if isAdmin(); // Only admins can approve/reject.
    }

    match /admin_notifications/{notificationId} {
      allow read, write: if isAdmin();
    }

    // --- Social & Communication Collections ---
    match /chats/{chatId} {
        // Members of the chat can read/write.
        allow read, write: if isAuth() && request.auth.uid in resource.data.members;
    }
    
    match /chats/{chatId}/messages/{messageId} {
        // Members of the chat can read/write.
        allow read, write: if isAuth() && get(/databases/$(database)/documents/chats/$(chatId)).data.members.hasAny([request.auth.uid]);
    }
    
    match /group_chats/{chatId} {
        // Any authenticated user can read group chats (they are public to members of a formation).
        allow read: if isAuth();
    }

    match /group_chats/{chatId}/messages/{messageId} {
       // Allow read for any authenticated user.
       allow read: if isAuth();
       // Allow write only if user is the author.
       allow create: if isAuth() && request.resource.data.authorId == request.auth.uid;
       // Disallow updates and deletes from client.
       allow update, delete: if false;
    }
    
    // --- Moderation & AI Collections (Admin-only) ---
    match /moderationLogs/{logId} {
        allow read, write: if false; // Server-only writes
    }
    
    match /aiFlags/{flagId} {
        allow read, write: if isAdmin();
    }
    
    match /moderationAppeals/{appealId} {
        allow read, update: if isAdmin();
        allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
    }
  }
}
